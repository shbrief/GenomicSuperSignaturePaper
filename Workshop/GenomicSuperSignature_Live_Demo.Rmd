---
title: "BioC2022 GenomicSuperSignature Package Demo"
author: "Sehyun Oh"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  BiocStyle::html_document:
    toc: true
    toc_float: false
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, message = FALSE, 
                      # eval = FALSE,
                      out.width = "70%", out.height = "70%")
```

# References
### Publication   

Oh S, Geistlinger L, Ramos M, Blankenberg D, van den Beek M, Taroni JN, Carey VJ, Waldron L, Davis S. GenomicSuperSignature facilitates interpretation of RNA-seq experiments through robust, efficient comparison to public databases. *Nature Communications* **2022**;13: 3695.
[doi: 10.1038/s41467-022-31411-3](https://www.nature.com/articles/s41467-022-31411-3)

### Bioconductor Package 
[GenomicSuperSignature](https://bioconductor.org/packages/release/bioc/html/GenomicSuperSignature.html)

### Use case and reproducible codes
[GenomicSuperSignaturePaper](https://shbrief.github.io/GenomicSuperSignaturePaper/)




# Setup
## Load packages
```{r}
BiocManager::install("shbrief/GenomicSuperSignature")

suppressPackageStartupMessages({
    library(GenomicSuperSignature)
    library(bcellViper)
    library(dplyr)
    library(AnVIL)
})
```

## Load RAVmodels
```{r}
## getModel
system.time(RAVmodel <- getModel("PLIERpriors"))   
system.time(RAVmodel_C2 <- getModel("C2"))   
```

# Database Search
```{r}
## Check the model
RAVmodel
geneSets(RAVmodel)

## Input data
data(bcellViper)
dset
```

```{r}
## validate
system.time(val_all <- validate(dset, RAVmodel)) 
heatmapTable(val_all, RAVmodel)
val_ind <- validatedSignatures(val_all, RAVmodel, indexOnly = TRUE)
```

```{r fig.width=9, fig.height=9}
## MeSH terms
# for (i in val_ind) {drawWordcloud(RAVmodel, ind = i)}
drawWordcloud(RAVmodel, val_ind[5])
```

```{r}
## GSEA
subsetEnrichedPathways(RAVmodel, val_ind[5]) %>% as.data.frame

## Relevant studies
findStudiesInCluster(RAVmodel, val_ind[5], studyTitle = TRUE)

## Misc metadata
getRAVInfo(RAVmodel, val_ind[5])
getStudyInfo(RAVmodel, "SRP095405")
```

# [Slide 17] TCGA-BRCA
```{r}
## The data file stored in Google Cloud Bucket using AnVIL package
dir <- "gs://genomic_super_signature"
fpath <- file.path(dir, "TCGA_validationDatasets.rda")

## Load the data
load(gsutil_pipe(fpath))

## Panel B
brca <- TCGA_validationDatasets[["BRCA"]]
system.time(val_brca <- validate(brca, RAVmodel_C2))
heatmapTable(val_brca, RAVmodel_C2)

## Panel C
drawWordcloud(RAVmodel, 221)

## Panel D
findStudiesInCluster(RAVmodel, 221, studyTitle = TRUE)

## Panel E
subsetEnrichedPathways(RAVmodel, 221, include_nes = TRUE) %>% as.data.frame
# annotateRAV(RAVmodel, 221, n = 10)
```



# [Slide 18] Annotated PCA plot
E-MTAB-2452 dataset
```{r}
## The data file stored in Google Cloud Bucket using AnVIL package
dir <- "gs://genomic_super_signature"
fpath <- file.path(dir, "E-MTAB-2452_hugene11st_SCANfast_with_GeneSymbol.pcl")
x <- gsutil_pipe(fpath, open = "rb")

## Load the data
annot.dat <- readr::read_tsv(x, show_col_types = FALSE) %>% as.data.frame
rownames(annot.dat) <- annot.dat[, 2]

dataset <- as.matrix(annot.dat[, 3:ncol(annot.dat)])
rownames(dataset) <- annot.dat$GeneSymbol
dataset[1:3, 1:3]
```

```{r}
system.time(val_all <- validate(dataset, RAVmodel))
annotatePC(2, val_all, RAVmodel, simplify = FALSE)
annotatePC(1:3, val_all, RAVmodel, scoreCutoff = 0)
```


Label each sample with their known cell type.
```{r}
cellType <- gsub("_.*$", "", colnames(dataset))
cellType <- gsub("CD4", "CD4,T cell", cellType)
cellType <- gsub("CD14", "CD14,monocyte", cellType)
cellType <- gsub("CD16", "CD16,neutrophil", cellType)
names(cellType) <- colnames(dataset)
```

```{r}
plotAnnotatedPCA(dataset, RAVmodel, c(2,3), val_all, 
                 scoreCutoff = 0.3, 
                 color_by = cellType, 
                 color_lab = "Cell Type")
```




# Session Info
<details>
```{r}
sessionInfo()
```
</details>
    
