---
title: "Reproduce multiPLIER Figure 3 - NARES"
author: "Sehyun Oh"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Quickstart}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    number_sections: no
    toc: yes
    toc_depth: 3
  BiocStyle::pdf_document:
    toc: true
    toc_float: false
    toc_depth: 3
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>", collapse = TRUE, message = FALSE, warning = FALSE 
)
```

```{r echo=FALSE}
suppressPackageStartupMessages({
  library(GenomicSuperSignature)
  library(GenomicSuperSignaturePaper)
  library(dplyr)
  library(RColorBrewer)
  library(ComplexHeatmap)
})
```


# Setup
In this vignette, we are reproducing Figure 3 of the [multiPLIER paper](https://www.sciencedirect.com/science/article/pii/S240547121930119X?via%3Dihub)
using GenomicSuperSignature.

## RAVmodel
To directly compare with the results from multiPLIER paper, we used the RAVmodel
annotated with the same priors: bloodCellMarkersIRISDMAP, svmMarkers, and canonicalPathways.

```{r message=FALSE, warning=FALSE, collapse=FALSE}
data.dir <- system.file("extdata", package = "GenomicSuperSignaturePaper")
RAVmodel <- readRDS(file.path(data.dir, "RAVmodel_PLIERpriors.rds"))
RAVmodel
updateNote(RAVmodel)
```


## NARES Nasal Brushings
- Expression data is downloaded from [here](https://github.com/greenelab/multi-plier/blob/master/data/expression_data/NARES_SCANfast_ComBat_with_GeneSymbol.pcl)      
- Analysis script is modified from [this](https://github.com/greenelab/multi-plier/blob/master/14-NARES_MCPcounter.Rmd)

### Expression data
NARES (Grayson et al., 2015) is a nasal brushing microarray dataset that includes 
patients with ANCA-associated vasculitis, patients with sarcoidosis and healthy 
controls among other groups and was projected into the MultiPLIER latent space.    

```{r}
exprs <- readr::read_tsv("data/NARES_SCANfast_ComBat_with_GeneSymbol.pcl") %>% 
  as.data.frame

rownames(exprs) <- exprs$GeneSymbol
dataset <- as.matrix(exprs[,3:ncol(exprs)])
dataset[1:2, 1:4]
```

```{r metadata, echo=FALSE, eval=FALSE}
demo <- read.table("data/NARES_demographic_data.tsv", sep = "\t", header = TRUE)
demo[1:3, 1:3]
colnames(demo)
```

### MCPcounter
NARES data doesn't have any information about the cell type composition of the 
samples, so in the multiPLIER paper, the authors applied [MCPcounter](https://github.com/ebecht/MCPcounter/tree/a79614eee002c88c64725d69140c7653e7c379b4) 
([Becht, et al. _Genome Biology_. 2016.](https://doi.org/10.1186/s13059-016-1070-5))
, which is a method for estimating cell type abundance in solid tissues.

As in multiPLIER paper, we tested if *neutrophil-associated* RAVs from RAVmodel 
are well-correlated with the neutrophil estimates from MCPcounter.

#### Install MCPcounter
```{r eval=FALSE}
devtools::install_github("ebecht/MCPcounter", 
                         ref = "a79614eee002c88c64725d69140c7653e7c379b4",
                         subdir = "Source",
                         dependencies = TRUE)
```

#### Run MCPcounter
```{r eval=FALSE}
mcp.results <- MCPcounter::MCPcounter.estimate(exprs.mat, featuresType = "HUGO_symbols")
mcp.melt <- reshape2::melt(mcp.results, varnames = c("Cell_type", "Sample"),
                           value.name = "MCP_estimate")
readr::write_tsv(mcp.melt, "data/NARES_ComBat_MCPCounter_results_tidy.tsv")
```

```{r echo=FALSE}
mcp.melt <- read.table("data/NARES_ComBat_MCPCounter_results_tidy.tsv", 
                       header = TRUE, sep = "\t")
```








# EDA
## Validation

```{r fig.width=4, fig.height=2}
val_all <- validate(dataset, RAVmodel) 
validated_ind <- validatedSignatures(val_all, num.out = 5, swCutoff = 0, indexOnly = TRUE)
heatmapTable(val_all, num.out = 5, swCutoff = 0)
```

RAV1551, neutrophil-associated RAV based on SLE-WB dataset, is not found in the 
top 5 validated RAVs of NARES dataset.

```{r collapse = TRUE}
ordered <- val_all[order(val_all$score, decreasing = TRUE),]
which(rownames(ordered) == "RAV1551")
head(val_all, 15)
```

## Sample score
```{r}
sampleScore <- calculateScore(dataset, RAVmodel)
```

```{r sample_score_heatmap_top5, echo=FALSE, eval=FALSE}
## Only with the top 5 RAVs
sampleScoreHeatmap(score = sampleScore[,validated_ind],
                   dataName = "NARES",
                   modelName = "RAVmodel",
                   show_column_names = FALSE,
                   row_names_gp = 4)
```

## GSEA
```{r}
## RAVs containing the keyword, "neutrophil", in each GSEA result
a <- gsea(RAVmodel)
b <- sapply(a, function(x) {
  y <- x[order(x$NES, decreasing = TRUE),][1:3,]   # top 3 NES
  grep("neutrophil", y[["Description"]], ignore.case = TRUE)
  })
c <- sapply(b, length)
table(c)

## RAVs with two keyword-containing pathways
which(c == 2)
sig_ind <- gsub("RAV", "", names(which(c == 2))) %>% as.numeric
```




# Interpret score
## Validated RAVs
Here, we tested the association between neutrophil count estimate of NARES data
against scores from validated RAVs.

```{r}
## Remove Sample category "gene"
gene_ind <- which(mcp.melt$Sample == "Gene")
mcp.melt <- mcp.melt[-gene_ind,]

## Subset sampleScore to join with MCPcounter
sampleScore_sub <- sampleScore[,validated_ind] %>% as.data.frame
sampleScore_sub <- tibble::rownames_to_column(sampleScore_sub)
colnames(sampleScore_sub)[1] <- "Sample"

## Join with MCPcounter neutrophil estimates
dat <- dplyr::filter(mcp.melt, Cell_type == "Neutrophils") %>%
  dplyr::inner_join(y = sampleScore_sub, by = "Sample")

head(dat, 3)
```

RAV1551 wasn't recovered and the most of the validated RAVs show a weak correlation
with neutrophil-count estimate, implying that neutrophil count is not a major 
feature of the NARES dataset.

```{r fig.height=7.5, fig.width=6}
plots <- list()
for (i in seq_along(validated_ind)) {
  plot <- LVScatter(dat, paste0("RAV", validated_ind[i]), 
                    y.var = "MCP_estimate",
                    ylab = "MCPcounter neutrophil estimate")
  plots[[i]] <- plot
}

gridExtra::grid.arrange(grobs = plots, cols = 2)
```

## Significant RAVs from GSEA
Object `dat2` is a data frame with neutrophil-estimate from MCPcounter and scores
assigned by significant RAVs selected by GSEA.

```{r}
## Subset sampleScore to join with MCPcounter
sampleScore_sub2 <- sampleScore[,sig_ind] %>% as.data.frame
sampleScore_sub2 <- tibble::rownames_to_column(sampleScore_sub2)
colnames(sampleScore_sub2)[1] <- "Sample"

## Join with MCPcounter neutrophil estimates
dat2 <- dplyr::filter(mcp.melt, Cell_type == "Neutrophils") %>%
  dplyr::inner_join(y = sampleScore_sub2, by = "Sample")

head(dat2, 3)
```

```{r fig.height=10, fig.width=9}
plots <- list()
for (i in seq_along(sig_ind)) {
  plot <- LVScatter(dat2, paste0("RAV", sig_ind[i]), 
                    y.var = "MCP_estimate",
                    ylab = "MCPcounter neutrophil estimate")
  plots[[i]] <- plot
}

gridExtra::grid.arrange(grobs = plots, cols = 2)
```

```{r save_for_paper, fig.width=4, fig.height=4.5, echo=FALSE, eval=FALSE}
## This chunk was executed only to save the summary table, not for vignettes.
plot <- LVScatter(dat2, paste0("RAV", 1551), 
                  y.var = "MCP_estimate",
                  ylab = "MCPcounter Neutrophil Estimate",
                  title = "RAVmodel",
                  subtitle = "NARES Nasal Brushings")
plot

saveRDS(plot, "outputs/nares_neutrophil.rds")
png("outputs/png/nares_neutrophil.png", width = 400, height = 400)
plot
dev.off()
```




# Session Info
```{r}
sessionInfo()
```
